<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Student Management</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="/students">
          ðŸŽ“ Student Manager
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="/students">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/students/add">Add Student</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/logout">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mb-4">
      <div
        class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2"
      >
        <div>
          <h1 class="h3 mb-1">Students</h1>
          <p class="text-muted mb-0">
            Manage all registered students from a single dashboard.
          </p>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="text-end">
            <div class="small text-muted text-uppercase">Total Students</div>
            <div class="fs-4 fw-semibold"><%= students.length %></div>
          </div>
          <a href="/students/add" class="btn btn-success"> + Add Student </a>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <form method="GET" action="/students" class="row g-2 mb-3">
            <div class="col-md-6 col-sm-8">
              <input
                type="text"
                name="q"
                class="form-control"
                placeholder="Search by name, email or mobile no..."
                value="<%= typeof q !== 'undefined' ? q : '' %>"
              />
            </div>
            <div class="col-md-2 col-sm-4">
              <button type="submit" class="btn btn-outline-primary w-100">
                Search
              </button>
            </div>
          </form>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Course</th>
                  <th>Admission Year</th>
                  <th>Email</th>
                  <th>Mobile No</th>
                  <th>DOB</th>
                  <th>Address</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (students.length === 0) { %>
                <tr>
                  <td colspan="9" class="text-center text-muted py-4">
                    No students found. Try adding a new student.
                  </td>
                </tr>
                <% } else { %> <% students.forEach(s => { %>
                <tr>
                  <td><%= s.id %></td>
                  <td><%= s.name %></td>
                  <td><%= s.course || '-' %></td>
                  <td><%= s.admission_year || '-' %></td>
                  <td><%= s.email || '-' %></td>
                  <td><%= s.mobile_no || '-' %></td>
                  <td>
                    <% if (s.dob) { %> <%= s.dob.toISOString ?
                    s.dob.toISOString().slice(0, 10) : s.dob %> <% } else { %> -
                    <% } %>
                  </td>
                  <td><%= s.address || '-' %></td>
                  <td class="text-center">
                    <div class="d-flex justify-content-center gap-2">
                      <a
                        href="/students/edit/<%= s.id %>"
                        class="btn btn-outline-secondary btn-sm"
                      >
                        Edit
                      </a>
                      <form
                        action="/students/delete/<%= s.id %>"
                        method="POST"
                        onsubmit="return confirm('Delete this student?')"
                        class="m-0"
                      >
                        <button
                          type="submit"
                          class="btn btn-outline-danger btn-sm"
                        >
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                <% }) %> <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <footer class="text-center text-muted small py-3">
      Â© <%= new Date().getFullYear() %> Student Management
    </footer>

    <!-- Bootstrap JS (optional, for navbar toggle) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      sessionStorage.setItem("activeSession", "true");

      window.addEventListener("beforeunload", function () {
        if (sessionStorage.getItem("activeSession")) {
          navigator.sendBeacon("/logout");
          sessionStorage.removeItem("activeSession");
        }
      });
    </script>
  </body>
</html>
